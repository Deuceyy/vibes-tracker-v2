<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibes TCG Tracker v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a25;
            --border: #2a2a3a;
            --text: #e8e8f0;
            --text-dim: #8888a0;
            --accent: #00ffaa;
            --accent-glow: rgba(0, 255, 170, 0.3);
            --win: #00ff88;
            --loss: #ff4466;
            --warning: #ffaa00;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .session-stats {
            display: flex;
            gap: 1.5rem;
            font-size: 1.1rem;
        }

        .session-stats span { color: var(--text-dim); }
        .session-stats .wins { color: var(--win); }
        .session-stats .losses { color: var(--loss); }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-dim);
        }

        .tab:hover { background: var(--bg-card-hover); }
        .tab.active { 
            background: var(--accent); 
            color: var(--bg-dark); 
            border-color: var(--accent);
        }

        .panel { display: none; }
        .panel.active { display: block; }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            color: var(--accent);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .form-group { margin-bottom: 1rem; }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: inherit;
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        button {
            padding: 0.75rem 1.5rem;
            background: var(--accent);
            color: var(--bg-dark);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        button:hover { transform: translateY(-2px); }

        .btn-win {
            background: var(--win);
            flex: 1;
            padding: 1rem;
            font-size: 1.2rem;
        }

        .btn-loss {
            background: var(--loss);
            flex: 1;
            padding: 1rem;
            font-size: 1.2rem;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .result-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        /* Card Tracking Section */
        .cards-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .cards-section h3 {
            color: var(--accent);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .card-input-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }

        .card-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .card-autocomplete.show { display: block; }

        .card-option {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }

        .card-option:hover { background: var(--bg-card-hover); }
        .card-option:last-child { border-bottom: none; }

        .cards-seen-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .card-tag {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .card-tag .remove {
            cursor: pointer;
            color: var(--loss);
            font-weight: bold;
        }

        /* Archetype Suggestion */
        .archetype-suggestion {
            background: var(--bg-dark);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .archetype-suggestion h4 {
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .archetype-matches {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .archetype-match {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: var(--bg-card);
            border-radius: 4px;
            cursor: pointer;
        }

        .archetype-match:hover { background: var(--bg-card-hover); }
        .archetype-match.selected { border: 1px solid var(--accent); }

        .confidence {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th { color: var(--text-dim); font-weight: 500; }

        .win-badge {
            background: var(--win);
            color: var(--bg-dark);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .loss-badge {
            background: var(--loss);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-box {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-box .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-box .label {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        /* Matchup table colors */
        .win-rate-high { color: var(--win); }
        .win-rate-low { color: var(--loss); }
        .win-rate-mid { color: var(--warning); }

        /* Analytics Section */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .analytics-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .analytics-card h3 {
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .card-stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .card-stat-row:last-child { border-bottom: none; }

        /* Recent matches in log panel */
        .recent-matches {
            margin-top: 2rem;
        }

        .match-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-dark);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .match-info { flex: 1; }
        .match-time { color: var(--text-dim); font-size: 0.85rem; }

        .delete-btn {
            background: transparent;
            color: var(--loss);
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .tabs { gap: 0.25rem; }
            .tab { padding: 0.5rem 1rem; font-size: 0.9rem; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">üêß Vibes Tracker v2</div>
        <div class="session-stats">
            <span>Today:</span>
            <span class="wins" id="session-wins">0</span>
            <span>-</span>
            <span class="losses" id="session-losses">0</span>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="log">üéÆ Log Match</div>
            <div class="tab" data-tab="stats">üìä Stats</div>
            <div class="tab" data-tab="analytics">üîç Card Analytics</div>
            <div class="tab" data-tab="search">üìã Search</div>
            <div class="tab" data-tab="decks">üìÅ My Decks</div>
        </div>

        <!-- Log Match Panel -->
        <div class="panel active" id="panel-log">
            <div class="card">
                <h2>üéÆ Log Match</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>My Deck</label>
                        <select id="my-deck">
                            <option value="">Select a deck...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Opponent Name</label>
                        <input type="text" id="opp-name" placeholder="Optional">
                    </div>
                    
                    <div class="form-group">
                        <label>Play / Draw</label>
                        <select id="on-play">
                            <option value="">Unknown</option>
                            <option value="1">On the Play</option>
                            <option value="0">On the Draw</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="notes" rows="2" placeholder="Optional notes..."></textarea>
                </div>

                <!-- Card Tracking Section -->
                <div class="cards-section">
                    <h3>üÉè Cards Seen (Opponent)</h3>
                    <p style="color: var(--text-dim); margin-bottom: 1rem; font-size: 0.9rem;">
                        Log cards as you see them. The system will suggest the opponent's deck archetype.
                    </p>
                    
                    <div class="card-input-wrapper">
                        <input type="text" id="card-search" placeholder="Type card name..." autocomplete="off">
                        <div class="card-autocomplete" id="card-autocomplete"></div>
                    </div>
                    
                    <div class="cards-seen-list" id="cards-seen-list"></div>
                    
                    <div class="archetype-suggestion" id="archetype-suggestion" style="display: none;">
                        <h4>Suggested Archetype</h4>
                        <div class="archetype-matches" id="archetype-matches"></div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1rem;">
                        <label>Opponent Deck (auto-filled or manual)</label>
                        <input type="text" id="opp-deck" placeholder="Will auto-fill from cards seen...">
                    </div>
                </div>

                <div class="result-buttons">
                    <button class="btn-win" onclick="logMatch('win')">üéâ WIN</button>
                    <button class="btn-loss" onclick="logMatch('loss')">üíÄ LOSS</button>
                </div>
            </div>

            <div class="card recent-matches">
                <h2>üìù Recent Matches</h2>
                <div id="recent-matches-list"></div>
            </div>
        </div>

        <!-- Stats Panel -->
        <div class="panel" id="panel-stats">
            <div class="card">
                <h2>üìä Statistics</h2>
                
                <div class="form-grid" style="margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label>Filter by Deck</label>
                        <select id="stats-deck-filter">
                            <option value="">All Decks</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>From</label>
                        <input type="date" id="stats-from">
                    </div>
                    <div class="form-group">
                        <label>To</label>
                        <input type="date" id="stats-to">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button onclick="loadStats()">Refresh</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="stat-total">0</div>
                        <div class="label">Matches</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="stat-wins">0</div>
                        <div class="label">Wins</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="stat-losses">0</div>
                        <div class="label">Losses</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="stat-winrate">0%</div>
                        <div class="label">Win Rate</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="stat-otp">0%</div>
                        <div class="label">OTP WR</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="stat-otd">0%</div>
                        <div class="label">OTD WR</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>‚öîÔ∏è Matchups</h2>
                <table id="matchups-table">
                    <thead>
                        <tr>
                            <th>Opponent Deck</th>
                            <th>Record</th>
                            <th>Win Rate</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Card Analytics Panel -->
        <div class="panel" id="panel-analytics">
            <div class="card">
                <h2>üîç Card Analytics</h2>
                <p style="color: var(--text-dim); margin-bottom: 1rem;">
                    See which cards you struggle against and which you beat.
                </p>
                
                <div class="form-group">
                    <label>Filter by My Deck</label>
                    <select id="analytics-deck-filter">
                        <option value="">All Decks</option>
                    </select>
                </div>
                <button onclick="loadAnalytics()" style="margin-bottom: 1.5rem;">Load Analytics</button>
            </div>

            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3>üò∞ Cards in Losses</h3>
                    <div id="cards-in-losses"></div>
                </div>
                
                <div class="analytics-card">
                    <h3>üòé Cards in Wins</h3>
                    <div id="cards-in-wins"></div>
                </div>
                
                <div class="analytics-card" style="grid-column: span 2;">
                    <h3>üìà Win Rate vs Card</h3>
                    <table id="winrate-vs-card-table">
                        <thead>
                            <tr>
                                <th>Card</th>
                                <th>Games</th>
                                <th>Record</th>
                                <th>Win Rate</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Search Panel -->
        <div class="panel" id="panel-search">
            <div class="card">
                <h2>üîç Search Matches</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Date From</label>
                        <input type="date" id="search-from">
                    </div>
                    <div class="form-group">
                        <label>Date To</label>
                        <input type="date" id="search-to">
                    </div>
                    <div class="form-group">
                        <label>My Deck</label>
                        <input type="text" id="search-my-deck" placeholder="Any">
                    </div>
                    <div class="form-group">
                        <label>Opponent Deck</label>
                        <input type="text" id="search-opp-deck" placeholder="Any">
                    </div>
                    <div class="form-group">
                        <label>Result</label>
                        <select id="search-result">
                            <option value="">All</option>
                            <option value="win">Win</option>
                            <option value="loss">Loss</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button onclick="searchMatches()">Search</button>
                    <button class="btn-secondary" onclick="clearSearch()">Clear</button>
                    <button class="btn-secondary" onclick="exportCSV()">üì• Export CSV</button>
                </div>
            </div>

            <div class="card">
                <h2>Results</h2>
                <table id="search-results-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>My Deck</th>
                            <th>Opponent</th>
                            <th>Their Deck</th>
                            <th>Result</th>
                            <th>Cards Seen</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Decks Panel -->
        <div class="panel" id="panel-decks">
            <div class="card">
                <h2>üì• Import Decklist</h2>
                <div class="form-group">
                    <label>Deck Name</label>
                    <input type="text" id="deck-name" placeholder="My Awesome Deck">
                </div>
                <div class="form-group">
                    <label>Paste deck JSON or card list</label>
                    <textarea id="deck-import" rows="6" placeholder='{"deckName": "...", "counts": {"CardName": 4, ...}}'></textarea>
                </div>
                <button onclick="importDeck()">Import Deck</button>
            </div>

            <div class="card">
                <h2>üìã My Decklists</h2>
                <div id="decklists"></div>
            </div>
        </div>
    </div>

    <script>
        // State
        let cardsList = [];
        let archetypes = [];
        let cardsSeen = [];
        let myDecks = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCards();
            loadArchetypes();
            loadMyDecks();
            loadSession();
            loadRecentMatches();
            setupTabs();
            setupCardAutocomplete();
        });

        // Tab switching
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
                    
                    if (tab.dataset.tab === 'stats') loadStats();
                    if (tab.dataset.tab === 'decks') loadDecklists();
                });
            });
        }

        // Load card list for autocomplete
        async function loadCards() {
            const res = await fetch('/api/cards');
            cardsList = await res.json();
        }

        // Load archetypes
        async function loadArchetypes() {
            const res = await fetch('/api/archetypes');
            archetypes = await res.json();
        }

        // Load user's decks for dropdown
        async function loadMyDecks() {
            const res = await fetch('/api/my-decks');
            myDecks = await res.json();
            
            const selects = ['my-deck', 'stats-deck-filter', 'analytics-deck-filter'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                const firstOption = select.options[0];
                select.innerHTML = '';
                select.appendChild(firstOption);
                myDecks.forEach(deck => {
                    const opt = document.createElement('option');
                    opt.value = deck;
                    opt.textContent = deck;
                    select.appendChild(opt);
                });
            });
        }

        // Card autocomplete
        function setupCardAutocomplete() {
            const input = document.getElementById('card-search');
            const dropdown = document.getElementById('card-autocomplete');
            
            input.addEventListener('input', () => {
                const query = input.value.toLowerCase();
                if (query.length < 2) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                const matches = cardsList.filter(c => {
                    const cardLower = c.toLowerCase();
                    const words = query.split(' ').filter(w => w.length > 0);
                    return words.every(word => cardLower.includes(word));
                }).slice(0, 10);
                
                if (matches.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                dropdown.innerHTML = matches.map(c => 
                    `<div class="card-option" onclick="addCard('${c}')">${c}</div>`
                ).join('');
                dropdown.classList.add('show');
            });
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const firstOption = dropdown.querySelector('.card-option');
                    if (firstOption) firstOption.click();
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.card-input-wrapper')) {
                    dropdown.classList.remove('show');
                }
            });
        }

        // Add card to seen list (allows duplicates for tracking multiple copies)
        function addCard(cardName) {
            cardsSeen.push(cardName);
            renderCardsSeen();
            detectArchetype();
            document.getElementById('card-search').value = '';
            document.getElementById('card-autocomplete').classList.remove('show');
        }

        // Remove card from seen list
        function removeCard(cardName) {
            cardsSeen = cardsSeen.filter(c => c !== cardName);
            renderCardsSeen();
            detectArchetype();
        }

        // Render cards seen list
        function renderCardsSeen() {
            const container = document.getElementById('cards-seen-list');
            container.innerHTML = cardsSeen.map(c => `
                <div class="card-tag">
                    ${c}
                    <span class="remove" onclick="removeCard('${c}')">√ó</span>
                </div>
            `).join('');
        }

        // Detect archetype from cards seen
        async function detectArchetype() {
            const suggestion = document.getElementById('archetype-suggestion');
            const matchesDiv = document.getElementById('archetype-matches');
            
            if (cardsSeen.length < 2) {
                suggestion.style.display = 'none';
                return;
            }
            
            const res = await fetch('/api/detect-archetype', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cards: cardsSeen })
            });
            
            const results = await res.json();
            
            if (results.length === 0) {
                suggestion.style.display = 'none';
                return;
            }
            
            suggestion.style.display = 'block';
            matchesDiv.innerHTML = results.slice(0, 3).map((r, i) => `
                <div class="archetype-match ${i === 0 ? 'selected' : ''}" 
                     onclick="selectArchetype('${r.archetype}')">
                    <span>${r.archetype}</span>
                    <span class="confidence">${r.confidence}% confidence</span>
                </div>
            `).join('');
            
            // Auto-fill the top suggestion
            if (results[0].confidence >= 50) {
                document.getElementById('opp-deck').value = results[0].archetype;
            }
        }

        // Select archetype manually
        function selectArchetype(archetype) {
            document.getElementById('opp-deck').value = archetype;
            document.querySelectorAll('.archetype-match').forEach(el => {
                el.classList.remove('selected');
                if (el.textContent.includes(archetype)) {
                    el.classList.add('selected');
                }
            });
        }

        // Log match
        async function logMatch(result) {
            const data = {
                my_deck: document.getElementById('my-deck').value,
                opp_name: document.getElementById('opp-name').value,
                opp_deck: document.getElementById('opp-deck').value,
                on_play: document.getElementById('on-play').value ? 
                         parseInt(document.getElementById('on-play').value) : null,
                notes: document.getElementById('notes').value,
                result: result,
                cards_seen: cardsSeen
            };
            
            await fetch('/api/matches', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            // Clear form
            document.getElementById('opp-name').value = '';
            document.getElementById('opp-deck').value = '';
            document.getElementById('on-play').value = '';
            document.getElementById('notes').value = '';
            cardsSeen = [];
            renderCardsSeen();
            document.getElementById('archetype-suggestion').style.display = 'none';
            
            // Refresh
            loadSession();
            loadRecentMatches();
        }

        // Load session stats
        async function loadSession() {
            const res = await fetch('/api/session');
            const data = await res.json();
            document.getElementById('session-wins').textContent = data.wins;
            document.getElementById('session-losses').textContent = data.losses;
        }

        // Load recent matches
        async function loadRecentMatches() {
            const res = await fetch('/api/matches');
            const matches = await res.json();
            
            const container = document.getElementById('recent-matches-list');
            container.innerHTML = matches.slice(0, 10).map(m => `
                <div class="match-row">
                    <div class="match-info">
                        <span class="${m.result_match ? 'win-badge' : 'loss-badge'}">
                            ${m.result_match ? 'W' : 'L'}
                        </span>
                        <strong>${m.my_deck || 'Unknown'}</strong> vs 
                        <strong>${m.opp_deck || 'Unknown'}</strong>
                        ${m.opp_name ? `(${m.opp_name})` : ''}
                        ${m.cards_seen?.length ? `<br><small style="color: var(--text-dim)">Cards: ${m.cards_seen.join(', ')}</small>` : ''}
                    </div>
                    <div class="match-time">${m.date_time}</div>
                    <button class="delete-btn" onclick="deleteMatch(${m.id})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        // Delete match
        async function deleteMatch(id) {
            if (!confirm('Delete this match?')) return;
            await fetch(`/api/matches/${id}`, { method: 'DELETE' });
            loadSession();
            loadRecentMatches();
        }

        // Load stats
        async function loadStats() {
            const deck = document.getElementById('stats-deck-filter').value;
            const from = document.getElementById('stats-from').value;
            const to = document.getElementById('stats-to').value;
            
            const params = new URLSearchParams();
            if (deck) params.set('my_deck', deck);
            if (from) params.set('date_from', from);
            if (to) params.set('date_to', to);
            
            const res = await fetch('/api/stats?' + params);
            const data = await res.json();
            
            document.getElementById('stat-total').textContent = data.total;
            document.getElementById('stat-wins').textContent = data.wins;
            document.getElementById('stat-losses').textContent = data.losses;
            document.getElementById('stat-winrate').textContent = data.win_rate + '%';
            document.getElementById('stat-otp').textContent = data.otp_win_rate + '%';
            document.getElementById('stat-otd').textContent = data.otd_win_rate + '%';
            
            // Matchups table
            const tbody = document.querySelector('#matchups-table tbody');
            tbody.innerHTML = data.matchups.map(m => `
                <tr>
                    <td>${m.opp_deck}</td>
                    <td>${m.wins}-${m.losses}</td>
                    <td class="${m.win_rate >= 60 ? 'win-rate-high' : m.win_rate <= 40 ? 'win-rate-low' : 'win-rate-mid'}">
                        ${m.win_rate}%
                    </td>
                </tr>
            `).join('');
        }

        // Load card analytics
        async function loadAnalytics() {
            const deck = document.getElementById('analytics-deck-filter').value;
            const params = deck ? `?my_deck=${encodeURIComponent(deck)}` : '';
            
            // Cards in losses
            const lossRes = await fetch('/api/analytics/cards-in-losses' + params);
            const lossData = await lossRes.json();
            document.getElementById('cards-in-losses').innerHTML = lossData.slice(0, 10).map(c => `
                <div class="card-stat-row">
                    <span>${c.card}</span>
                    <span style="color: var(--loss)">${c.count} games</span>
                </div>
            `).join('') || '<p style="color: var(--text-dim)">No data yet</p>';
            
            // Cards in wins
            const winRes = await fetch('/api/analytics/cards-in-wins' + params);
            const winData = await winRes.json();
            document.getElementById('cards-in-wins').innerHTML = winData.slice(0, 10).map(c => `
                <div class="card-stat-row">
                    <span>${c.card}</span>
                    <span style="color: var(--win)">${c.count} games</span>
                </div>
            `).join('') || '<p style="color: var(--text-dim)">No data yet</p>';
            
            // Win rate vs card
            const wrRes = await fetch('/api/analytics/winrate-vs-card' + params);
            const wrData = await wrRes.json();
            document.querySelector('#winrate-vs-card-table tbody').innerHTML = wrData.slice(0, 15).map(c => `
                <tr>
                    <td>${c.card}</td>
                    <td>${c.total}</td>
                    <td>${c.wins}-${c.losses}</td>
                    <td class="${c.win_rate >= 60 ? 'win-rate-high' : c.win_rate <= 40 ? 'win-rate-low' : 'win-rate-mid'}">
                        ${c.win_rate}%
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="4" style="color: var(--text-dim)">No data yet</td></tr>';
        }

        // Search matches
        async function searchMatches() {
            const params = new URLSearchParams();
            
            const from = document.getElementById('search-from').value;
            const to = document.getElementById('search-to').value;
            const myDeck = document.getElementById('search-my-deck').value;
            const oppDeck = document.getElementById('search-opp-deck').value;
            const result = document.getElementById('search-result').value;
            
            if (from) params.set('date_from', from);
            if (to) params.set('date_to', to);
            if (myDeck) params.set('my_deck', myDeck);
            if (oppDeck) params.set('opp_deck', oppDeck);
            if (result) params.set('result', result);
            
            const res = await fetch('/api/matches?' + params);
            const matches = await res.json();
            
            const tbody = document.querySelector('#search-results-table tbody');
            tbody.innerHTML = matches.map(m => `
                <tr>
                    <td>${m.date_time}</td>
                    <td>${m.my_deck || '-'}</td>
                    <td>${m.opp_name || '-'}</td>
                    <td>${m.opp_deck || '-'}</td>
                    <td><span class="${m.result_match ? 'win-badge' : 'loss-badge'}">${m.result_match ? 'W' : 'L'}</span></td>
                    <td><small>${m.cards_seen?.join(', ') || '-'}</small></td>
                    <td><button class="delete-btn" onclick="deleteMatch(${m.id}); searchMatches();">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }

        function clearSearch() {
            document.getElementById('search-from').value = '';
            document.getElementById('search-to').value = '';
            document.getElementById('search-my-deck').value = '';
            document.getElementById('search-opp-deck').value = '';
            document.getElementById('search-result').value = '';
            document.querySelector('#search-results-table tbody').innerHTML = '';
        }

        function exportCSV() {
            window.location.href = '/api/export/csv';
        }

        // Decklists
        async function loadDecklists() {
            const res = await fetch('/api/decklists');
            const decks = await res.json();
            
            const container = document.getElementById('decklists');
            if (decks.length === 0) {
                container.innerHTML = '<p style="color: var(--text-dim)">No decklists yet. Import one above!</p>';
                return;
            }
            
            container.innerHTML = decks.map(d => `
                <div class="match-row">
                    <div class="match-info">
                        <strong>${d.name}</strong>
                        <br><small style="color: var(--text-dim)">${d.created_at}</small>
                    </div>
                    <button class="delete-btn" onclick="deleteDeck(${d.id})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        async function importDeck() {
            const name = document.getElementById('deck-name').value;
            const rawInput = document.getElementById('deck-import').value;
            
            let cards = {};
            try {
                const parsed = JSON.parse(rawInput);
                cards = parsed.counts || parsed;
                if (!name && parsed.deckName) {
                    document.getElementById('deck-name').value = parsed.deckName;
                }
            } catch {
                // Try parsing as simple list
                rawInput.split('\n').forEach(line => {
                    const match = line.match(/(\d+)x?\s*(.+)/);
                    if (match) {
                        cards[match[2].trim()] = parseInt(match[1]);
                    }
                });
            }
            
            await fetch('/api/decklists', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: document.getElementById('deck-name').value || 'Unnamed Deck',
                    cards: cards
                })
            });
            
            document.getElementById('deck-name').value = '';
            document.getElementById('deck-import').value = '';
            loadDecklists();
            loadMyDecks();
        }

        async function deleteDeck(id) {
            if (!confirm('Delete this decklist?')) return;
            await fetch(`/api/decklists/${id}`, { method: 'DELETE' });
            loadDecklists();
            loadMyDecks();
        }
    </script>
</body>
</html>
